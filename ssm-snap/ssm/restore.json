{
    "description": "Sample Automation Document Using AWS API Actions",
    "schemaVersion": "0.3",
    "assumeRole": "{{ AutomationAssumeRole }}",
    "parameters": {
        "AutomationAssumeRole": {
            "type": "String",
            "description": "(Optional) The ARN of the role that allows Automation to perform the actions on your behalf.",
            "default": ""
        },
        "SourceInstanceId": {
            "type": "String",
            "description": "Source SQL Server"
        },
        "DestInstanceId": {
            "type": "String",
            "description": "Destination SQL Server"
        }
    },
    "mainSteps": [
        {
            "name": "createVssSnapshots",
            "action": "aws:runCommand",
            "inputs": {
                "DocumentName": "AWSEC2-CreateVssSnapshot",
                "InstanceIds": [
                    "{{ SourceInstanceId }}"
                ],
                "Parameters": {
                    "ExcludeBootVolume": "True",
                    "tags": "Key=Name,Value=VSS Snapshot;Key=BackupId,Value={{ automation:EXECUTION_ID }}"
                }
            }
        },
        {
            "name": "getSnapshotIds",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DescribeSnapshots",
                "Filters": [
                    {
                        "Name": "tag:BackupId",
                        "Values": [
                            "{{ automation:EXECUTION_ID }}"
                        ]
                    }
                ]
            },
            "outputs": [
                {
                    "Name": "SnapshotId0",
                    "Selector": "$.Snapshots[0].SnapshotId",
                    "Type": "String"
                },
                {
                    "Name": "SnapshotId1",
                    "Selector": "$.Snapshots[1].SnapshotId",
                    "Type": "String"
                },
                {
                    "Name": "SnapshotId2",
                    "Selector": "$.Snapshots[2].SnapshotId",
                    "Type": "String"
                }
            ]
        },
        {
            "name": "checkSnapshots",
            "action": "aws:waitForAwsResourceProperty",
            "timeoutSeconds": 300,
            "inputs": {
                "Service": "ec2",
                "Api": "DescribeSnapshots",
                "SnapshotIds": [
                    "{{ getSnapshotIds.SnapshotId0 }}",
                    "{{ getSnapshotIds.SnapshotId1 }}",
                    "{{ getSnapshotIds.SnapshotId2 }}"
                ],
                "PropertySelector": "$.Snapshots[0].State",
                "DesiredValues": [
                    "completed"
                ]
            }
        },
        {
            "name": "createVolume0",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "CreateVolume",
                "AvailabilityZone": "ap-southeast-2a",
                "SnapshotId": "{{ getSnapshotIds.SnapshotId0 }}"
            },
            "outputs": [
                {
                    "Name": "VolumeId0",
                    "Selector": "$.VolumeId",
                    "Type": "String"
                }
            ]
        },
        {
            "name": "createVolume1",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "CreateVolume",
                "AvailabilityZone": "ap-southeast-2a",
                "SnapshotId": "{{ getSnapshotIds.SnapshotId1 }}"
            },
            "outputs": [
                {
                    "Name": "VolumeId1",
                    "Selector": "$.VolumeId",
                    "Type": "String"
                }
            ]
        },
        {
            "name": "createVolume2",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "CreateVolume",
                "AvailabilityZone": "ap-southeast-2a",
                "SnapshotId": "{{ getSnapshotIds.SnapshotId2 }}"
            },
            "outputs": [
                {
                    "Name": "VolumeId2",
                    "Selector": "$.VolumeId",
                    "Type": "String"
                }
            ]
        },
        {
            "name": "checkVolumes",
            "action": "aws:waitForAwsResourceProperty",
            "timeoutSeconds": 300,
            "inputs": {
                "Service": "ec2",
                "Api": "DescribeVolumes",
                "VolumeIds": [
                    "{{ createVolume0.VolumeId0 }}",
                    "{{ createVolume1.VolumeId1 }}",
                    "{{ createVolume2.VolumeId2 }}"
                ],
                "PropertySelector": "$.Volumes..State",
                "DesiredValues": [
                    "available"
                ]
            }
        },
        {
            "name": "attachVolume0",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "AttachVolume",
                "VolumeId": "{{ createVolume0.VolumeId0 }}",
                "InstanceId": "{{ DestInstanceId }}",
                "Device": "xvdh"
            }
        },
        {
            "name": "attachVolume1",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "AttachVolume",
                "VolumeId": "{{ createVolume1.VolumeId1 }}",
                "InstanceId": "{{ DestInstanceId }}",
                "Device": "xvdf"
            }
        },
        {
            "name": "attachVolume2",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "AttachVolume",
                "VolumeId": "{{ createVolume2.VolumeId2 }}",
                "InstanceId": "{{ DestInstanceId }}",
                "Device": "xvdg"
            }
        },
        {
            "name": "runDiskScript",
            "action": "aws:runCommand",
            "inputs": {
                "DocumentName": "UpdateHostStorageCache",
                "InstanceIds": [
                    "{{ DestInstanceId }}"
                ]
            }
        },
        {
            "name": "runSQLScript",
            "action": "aws:runCommand",
            "timeoutSeconds": 2592000,
            "inputs": {
                "DocumentName": "SSIS",
                "InstanceIds": [
                    "{{ DestInstanceId }}"
                ]
            },
            "isEnd": false
        },
        {
            "name": "detachVolume0",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DetachVolume",
                "VolumeId": "{{ createVolume0.VolumeId0 }}",
                "InstanceId": "{{ DestInstanceId }}",
                "Device": "xvdh"
            }
        },
        {
            "name": "detachVolume1",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DetachVolume",
                "VolumeId": "{{ createVolume1.VolumeId1 }}",
                "InstanceId": "{{ DestInstanceId }}",
                "Device": "xvdf"
            }
        },
        {
            "name": "detachVolume2",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DetachVolume",
                "VolumeId": "{{ createVolume2.VolumeId2 }}",
                "InstanceId": "{{ DestInstanceId }}",
                "Device": "xvdg"
            }
        },
        {
            "name": "checkVolumesBeforeDelete",
            "action": "aws:waitForAwsResourceProperty",
            "timeoutSeconds": 300,
            "inputs": {
                "Service": "ec2",
                "Api": "DescribeVolumes",
                "VolumeIds": [
                    "{{ createVolume0.VolumeId0 }}",
                    "{{ createVolume1.VolumeId1 }}",
                    "{{ createVolume2.VolumeId2 }}"
                ],
                "PropertySelector": "$.Volumes..State",
                "DesiredValues": [
                    "available"
                ]
            }
        },
        {
            "name": "deleteVolume0",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DeleteVolume",
                "VolumeId": "{{ createVolume0.VolumeId0 }}"
            }
        },
        {
            "name": "deleteVolume1",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DeleteVolume",
                "VolumeId": "{{ createVolume1.VolumeId1 }}"
            }
        },
        {
            "name": "deleteVolume2",
            "action": "aws:executeAwsApi",
            "inputs": {
                "Service": "ec2",
                "Api": "DeleteVolume",
                "VolumeId": "{{ createVolume2.VolumeId2 }}"
            }
        }
    ]
}